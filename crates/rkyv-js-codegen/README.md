# rkyv-js-codegen

Rust crate for generating TypeScript decoder bindings from rkyv types.

## Overview

This crate generates TypeScript code that works with the [`rkyv-js`](https://www.npmjs.com/package/rkyv-js) npm package, enabling you to decode rkyv-serialized data in TypeScript/JavaScript.

## Installation

```toml
[dependencies]
rkyv-js-codegen = "0.1"

[build-dependencies]
rkyv-js-codegen = "0.1"
```

## Usage

### Using `CodeGenerator` in `build.rs`

```rust
// build.rs
use rkyv_js_codegen::{CodeGenerator, TypeDef, EnumVariant};

fn main() {
    let mut gen = CodeGenerator::new();

    // Add a struct
    gen.add_struct("Person", &[
        ("name", TypeDef::String),
        ("age", TypeDef::U32),
        ("email", TypeDef::Option(Box::new(TypeDef::String))),
        ("scores", TypeDef::Vec(Box::new(TypeDef::U32))),
    ]);

    // Add an enum
    gen.add_enum("Status", &[
        EnumVariant::Unit("Pending".to_string()),
        EnumVariant::Unit("Active".to_string()),
        EnumVariant::Struct("Error".to_string(), vec![
            ("message".to_string(), TypeDef::String),
            ("code".to_string(), TypeDef::U32),
        ]),
    ]);

    // Write to file
    gen.write_to_file("generated/bindings.ts").unwrap();

    println!("cargo:rerun-if-changed=build.rs");
}
```

### Using `#[derive(TypeScript)]`

```rust
use rkyv::Archive;
use rkyv_js_codegen::TypeScript;

#[derive(Archive, TypeScript)]
pub struct Person {
    pub name: String,
    pub age: u32,
}

// The derive macro generates:
// - Person::typescript_def() -> type definition
// - __register_typescript_person() -> registration function
```

## API

### `CodeGenerator`

```rust
let mut gen = CodeGenerator::new();

// Optional: Set a custom header comment
gen.set_header("Generated by my-project");

// Add types
gen.add_struct(name, &[(field_name, TypeDef)]);
gen.add_enum(name, &[EnumVariant]);
gen.add_alias(name, TypeDef);

// Generate output
let code: String = gen.generate();
gen.write_to_file("path/to/output.ts")?;
```

### `TypeDef`

```rust
pub enum TypeDef {
    // Primitives
    U8, I8, U16, I16, U32, I32, U64, I64,
    F32, F64, Bool, Char, Unit, String,
    
    // Containers
    Vec(Box<TypeDef>),
    Option(Box<TypeDef>),
    Box(Box<TypeDef>),
    Array(Box<TypeDef>, usize),
    Tuple(Vec<TypeDef>),
    HashMap(Box<TypeDef>, Box<TypeDef>),
    BTreeMap(Box<TypeDef>, Box<TypeDef>),
    
    // Reference to another type
    Named(String),
}
```

### `EnumVariant`

```rust
pub enum EnumVariant {
    // Unit variant: `Quit`
    Unit(String),
    
    // Tuple variant: `Write(String)`
    Tuple(String, Vec<TypeDef>),
    
    // Struct variant: `Move { x: i32, y: i32 }`
    Struct(String, Vec<(String, TypeDef)>),
}
```

## Generated Output Example

For this Rust code:

```rust
gen.add_struct("Person", &[
    ("name", TypeDef::String),
    ("age", TypeDef::U32),
]);
```

The generated TypeScript:

```typescript
import {
  struct,
  u32,
  string,
  type RkyvDecoder,
} from 'rkyv-js';

export interface Person {
  name: string;
  age: number;
}

export const PersonDecoder: RkyvDecoder<Person> = struct({
  name: { decoder: string },
  age: { decoder: u32 },
});
```

## Features

- **Dependency ordering**: Types are automatically sorted so dependencies come first
- **Smart imports**: Only imports the decoders actually used
- **Type inference**: Generated decoders are fully typed

## License

MIT
